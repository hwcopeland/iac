alloy:
  configMap:
    content: |
      loki.source.syslog "mikrotik" {
        listener {
          address = "0.0.0.0:514"
          protocol = "udp"
          syslog_format = "rfc3164"
          use_incoming_timestamp = false
          labels = { job = "mikrotik_firewall" }
        }
        forward_to = [loki.process.enrichment.receiver]
      }

      loki.process "enrichment" {
        stage.regex {
          expression = "^(?P<action>.*?) forward: proto (?P<proto>.*?), (?P<src_ip>[0-9.]+):"
        }

        stage.labels {
          values = {
            action = "action",
            proto  = "proto",
          }
        }

        stage.geoip {
          db = "/var/lib/geoip/GeoLite2-ASN.mmdb"
          source = "src_ip"
          db_type = "asn"
        }

        stage.geoip {
          db = "/var/lib/geoip/GeoLite2-City.mmdb"
          source = "src_ip"
          db_type = "city"
        }

        forward_to = [loki.write.local.receiver]
      }

      loki.write "local" {
        endpoint {
          url = "http://loki-gateway.monitor.svc.cluster.local/loki/api/v1/push"
        }
      }
  mounts:
    extra:
      - name: geoip-db
        mountPath: /var/lib/geoip
        readOnly: true

controller:
  type: deployment
  replicas: 1

  # Define the emptyDir volume to store downloaded databases
  volumes:
    extra:
      - name: geoip-db
        emptyDir: {}

  # Init container to download and manage GeoIP databases with version checking
  initContainers:
    - name: download-geoip
      image: alpine:latest
      command:
        - sh
        - -c
        - |
          set -e
          
          GEOIP_DIR="/var/lib/geoip"
          mkdir -p "$GEOIP_DIR"
          
          echo "=========================================="
          echo "GeoIP Database Download and Update Check"
          echo "=========================================="
          
          # Function to download and verify a database
          download_db() {
            local db_name=$1
            local db_url=$2
            local db_path="$GEOIP_DIR/$db_name"
            
            echo ""
            echo "Downloading $db_name..."
            
            # Download with retry logic
            for attempt in 1 2 3; do
              if wget -q -O "$db_path.tmp" "$db_url"; then
                # Verify file is not empty
                if [ -s "$db_path.tmp" ]; then
                  # Calculate checksum of new file
                  new_checksum=$(md5sum "$db_path.tmp" | awk '{print $1}')
                  
                  # Check if old file exists and compare checksums
                  if [ -f "$db_path" ]; then
                    old_checksum=$(md5sum "$db_path" | awk '{print $1}')
                    old_size=$(stat -c%s "$db_path")
                    new_size=$(stat -c%s "$db_path.tmp")
                    
                    if [ "$old_checksum" != "$new_checksum" ]; then
                      echo "  ✓ Version difference detected!"
                      echo "    Old: $old_checksum (size: $old_size bytes)"
                      echo "    New: $new_checksum (size: $new_size bytes)"
                      mv "$db_path.tmp" "$db_path"
                      echo "    Updated to new version"
                    else
                      echo "  ✓ Version is current (no changes needed)"
                      rm "$db_path.tmp"
                    fi
                  else
                    echo "  ✓ Downloaded successfully"
                    new_checksum=$(md5sum "$db_path.tmp" | awk '{print $1}')
                    new_size=$(stat -c%s "$db_path.tmp")
                    echo "    Checksum: $new_checksum (size: $new_size bytes)"
                    mv "$db_path.tmp" "$db_path"
                  fi
                  return 0
                else
                  echo "  ✗ Downloaded file is empty, retrying..."
                  rm "$db_path.tmp"
                fi
              else
                echo "  ✗ Download failed (attempt $attempt/3)"
              fi
              
              if [ $attempt -lt 3 ]; then
                echo "    Waiting 5 seconds before retry..."
                sleep 5
              fi
            done
            
            echo "  ✗ Failed to download $db_name after 3 attempts"
            return 1
          }
          
          # Download all three databases
          download_db "GeoLite2-ASN.mmdb" "https://github.com/P3TERX/GeoLite.mmdb/raw/download/GeoLite2-ASN.mmdb"
          download_db "GeoLite2-City.mmdb" "https://github.com/P3TERX/GeoLite.mmdb/raw/download/GeoLite2-City.mmdb"
          download_db "GeoLite2-Country.mmdb" "https://github.com/P3TERX/GeoLite.mmdb/raw/download/GeoLite2-Country.mmdb"
          
          echo ""
          echo "=========================================="
          echo "Final Database Status"
          echo "=========================================="
          ls -lh "$GEOIP_DIR/"
          
          # Verify all required files exist
          if [ ! -f "$GEOIP_DIR/GeoLite2-ASN.mmdb" ] || [ ! -s "$GEOIP_DIR/GeoLite2-ASN.mmdb" ]; then
            echo "✗ ERROR: GeoLite2-ASN.mmdb is missing or empty"
            exit 1
          fi
          
          echo "✓ All databases ready"
      
      volumeMounts:
        - name: geoip-db
          mountPath: /var/lib/geoip
      
      resources:
        requests:
          memory: "128Mi"
          cpu: "100m"
        limits:
          memory: "256Mi"
          cpu: "500m"

  podAnnotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "12345"

resources:
  requests:
    memory: "256Mi"
    cpu: "100m"
  limits:
    memory: "512Mi"
    cpu: "500m"

# Expose syslog listener to external networks via NodePort
service:
  enabled: true
  type: LoadBalancer
  annotations: {}
  labels: {}
  ports:
    syslog:
      port: 514
      targetPort: 514
      protocol: UDP
